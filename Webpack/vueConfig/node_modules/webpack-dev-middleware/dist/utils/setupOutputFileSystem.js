const path = require("path");
const memfs = require("memfs");

function setupOutputFileSystem(context) {
  let outputFileSystem;

  if (context.options.outputFileSystem) {
    const {
      outputFileSystem: outputFileSystemFromOptions
    } = context.options; 

    if (typeof outputFileSystemFromOptions.join !== "function") {
      throw new Error("Invalid options: options.outputFileSystem.join() method is expected");
    } 

    if (typeof outputFileSystemFromOptions.mkdirp !== "function") {
      throw new Error("Invalid options: options.outputFileSystem.mkdirp() method is expected");
    }

    outputFileSystem = outputFileSystemFromOptions;
  } else {
    // 如果没有outputFileSystem就创建
    outputFileSystem = memfs.createFsFromVolume(new memfs.Volume());
    outputFileSystem.join = path.join.bind(path);
  }

  const compilers = context.compiler.compilers || [context.compiler];
  // 给每个compiler加outputFileSystem
  for (const compiler of compilers) {
    compiler.outputFileSystem = outputFileSystem;
  } 
  context.outputFileSystem = outputFileSystem;
}

module.exports = setupOutputFileSystem;